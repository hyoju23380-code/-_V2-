<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ê±´ê°•ê´€ë¦¬ì‹¤ ì˜ì•½í’ˆ ì¬ê³  (ì˜¤í”„ë¼ì¸ HTML)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --line:#1f2937;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,Helvetica,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid #111}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:8px 0}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{padding:10px 14px;border-radius:10px;border:1px solid #222;background:#111;color:var(--text);cursor:pointer}
  nav button.active{background:#1f2937}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:1.3fr .7fr}}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .muted{color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263042;background:#0b1220;color:var(--text)}
  label{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #263042;text-align:left;font-size:14px}
  th{color:#aab4c1}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .btn{padding:10px 14px;border:1px solid #263042;border-radius:10px;background:#0b1220;color:var(--text);cursor:pointer}
  .btn.primary{background:#14532d;border-color:#166534}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3342}
  .pill.warn{background:#3a2b03;color:#fbbf24}
  .pill.danger{background:#3a0a0a;color:#f87171}
  .flex{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .mt8{margin-top:8px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .right{justify-content:flex-end}
  canvas{width:100%;height:280px;background:#0b1220;border:1px solid #263042;border-radius:10px}
  .footer{color:#64748b;font-size:12px;margin-top:30px}
  .kbd{border:1px solid #334155;padding:1px 6px;border-radius:6px;background:#0b1220}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ğŸ¥ ê±´ê°•ê´€ë¦¬ì‹¤ ì˜ì•½í’ˆ ì¬ê³  (ì˜¤í”„ë¼ì¸ HTML)</h1>
    <nav id="tabs">
      <button data-tab="dash" class="active">ëŒ€ì‹œë³´ë“œ</button>
      <button data-tab="inout">ì…ê³ /ì‚¬ìš©</button>
      <button data-tab="batches">ë°°ì¹˜/ìœ í†µê¸°í•œ</button>
      <button data-tab="reports">ì›”ë³„ í†µê³„</button>
      <button data-tab="settings">ì„¤ì •/ë°±ì—…</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- DASHBOARD -->
  <section id="tab-dash">
    <div class="grid">
      <div class="card">
        <div class="flex"><h2>ì¬ê³  í˜„í™©</h2><span class="muted" id="asof"></span></div>
        <table id="tblOnhand"><thead>
          <tr><th>ì˜ì•½í’ˆ</th><th>ë‹¨ìœ„</th><th>í˜„ì¬ê³ </th><th>ì•ˆì „ì¬ê³ </th><th>ìµœë‹¨ ìœ í†µê¸°í•œ</th><th>ìƒíƒœ</th></tr>
        </thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>ê²½ê³ </h3>
        <div id="alerts"></div>
      </div>
    </div>
  </section>

  <!-- IN/OUT -->
  <section id="tab-inout" style="display:none">
    <div class="grid">
      <div class="card">
        <h3>ì˜ì•½í’ˆ ë“±ë¡(í•œ ë²ˆë§Œ)</h3>
        <div class="row">
          <div><label>ì˜ì•½í’ˆëª…</label><input id="medName" placeholder="ì˜ˆ: ì•„ì„¸íŠ¸ì•„ë¯¸ë…¸íœ 500mg"></div>
          <div><label>ë‹¨ìœ„(ì„ íƒ)</label><input id="medUnit" placeholder="ì •/ìº¡ìŠ/ì•°í”Œ"></div>
        </div>
        <div class="row mt8">
          <div><label>ì•ˆì „ì¬ê³  ê¸°ì¤€</label><input id="medThreshold" type="number" min="1" value="10"></div>
        </div>
        <div class="mt8 right"><button class="btn primary" id="btnAddMed">ë“±ë¡</button></div>
      </div>

      <div class="card">
        <h3>ì…ê³  ì²˜ë¦¬</h3>
        <div class="row3">
          <div><label>ì˜ì•½í’ˆ</label><select id="rcvMed"></select></div>
          <div><label>ë¡œíŠ¸/ë°°ì¹˜</label><input id="rcvLot" placeholder="ì˜ˆ: LOT-2025-11"></div>
          <div><label>ìœ í†µê¸°í•œ</label><input id="rcvExp" type="date"></div>
        </div>
        <div class="row mt8">
          <div><label>ì…ê³  ìˆ˜ëŸ‰</label><input id="rcvQty" type="number" min="1" value="10"></div>
          <div><label>ë¹„ê³ </label><input id="rcvNote"></div>
        </div>
        <div class="mt8 right"><button class="btn primary" id="btnReceive">ì…ê³  ë°˜ì˜</button></div>
      </div>

      <div class="card">
        <h3>ì‚¬ìš©(ì¶œê³ ) ì²˜ë¦¬</h3>
        <div class="row">
          <div><label>ì˜ì•½í’ˆ</label><select id="useMed"></select></div>
          <div><label>ì‚¬ìš© ìˆ˜ëŸ‰</label><input id="useQty" type="number" min="1" value="1"></div>
        </div>
        <div class="row mt8">
          <div><label>ë¹„ê³ </label><input id="useNote"></div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end">
            <button class="btn primary" id="btnUse">ì‚¬ìš© ë°˜ì˜(FEFO)</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- BATCHES -->
  <section id="tab-batches" style="display:none">
    <div class="card">
      <h3>ë°°ì¹˜ ëª©ë¡</h3>
      <table id="tblBatches"><thead>
        <tr><th>ì˜ì•½í’ˆ</th><th>ë¡œíŠ¸</th><th>ìœ í†µê¸°í•œ</th><th>ìˆ˜ëŸ‰</th><th>ì…ê³ ì¼</th></tr>
      </thead><tbody></tbody></table>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="tab-reports" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <label>ê¸°ì¤€ ì›”</label>
          <input id="repMonth" type="month">
        </div>
        <div>
          <label>ìµœê·¼ nê°œì›”</label>
          <input id="repN" type="number" min="3" max="24" value="12">
        </div>
      </div>
      <div class="mt16">
        <h3>í•´ë‹¹ ì›” ì‚¬ìš© Top 10</h3>
        <canvas id="barTop"></canvas>
      </div>
      <div class="mt16">
        <h3>ì›”ë³„ ì‚¬ìš©/ì…ê³  ì¶”ì´</h3>
        <canvas id="lineTrend"></canvas>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" style="display:none">
    <div class="grid">
      <div class="card">
        <h3>ì˜ì•½í’ˆ ì‚­ì œ</h3>
        <div class="row">
          <div><label>ì˜ì•½í’ˆ</label><select id="delMed"></select></div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end">
            <button class="btn" id="btnDelete">ì‚­ì œ</button>
          </div>
        </div>
        <p class="muted">â€» ì‚­ì œ ì‹œ í•´ë‹¹ ì˜ì•½í’ˆì˜ ë°°ì¹˜/ë‚´ì—­ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</p>
      </div>
      <div class="card">
        <h3>ë°±ì—…/ë³µì›</h3>
        <div class="row">
          <div>
            <button class="btn" id="btnExport">ë°ì´í„° ë‚´ë³´ë‚´ê¸°(JSON)</button>
          </div>
          <div>
            <input id="impFile" type="file" accept=".json">
            <button class="btn" id="btnImport">ê°€ì ¸ì˜¤ê¸°</button>
          </div>
        </div>
        <p class="muted mt8">ë‚´ë³´ë‚¸ JSON íŒŒì¼ì„ ë‹¤ë¥¸ PCë¡œ ì˜®ê²¨ â€œê°€ì ¸ì˜¤ê¸°â€í•˜ë©´ ê·¸ëŒ€ë¡œ ë³µì›ë©ë‹ˆë‹¤.</p>
      </div>
    </div>
    <div class="footer">
      âŒ¨ï¸ íŒ: ê²€ìƒ‰ì€ <span class="kbd">Ctrl</span>+<span class="kbd">F</span>, ìƒˆë¡œê³ ì¹¨ì€ <span class="kbd">F5</span>
    </div>
  </section>
</main>

<script>
const KEY='medinv_v1';
function load(){try{return JSON.parse(localStorage.getItem(KEY))||{meds:[],batches:[],tx:[]};}catch(e){return {meds:[],batches:[],tx:[]};}}
function save(db){localStorage.setItem(KEY,JSON.stringify(db));}
const fmtDate=d=>d?new Date(d).toISOString().slice(0,10):'';
function today(){const d=new Date();d.setHours(0,0,0,0);return d;}
function parseDateInput(v){return v?new Date(v+'T00:00:00'):null;}
function onhand(db){
  const map={}; db.meds.forEach(m=>map[m.id]={name:m.name,unit:m.unit||'',threshold:m.threshold||10,onhand:0,soonest:null});
  db.batches.forEach(b=>{const m=map[b.medId]; if(!m)return; m.onhand+=b.qty; if(b.qty>0&&b.expiry){const d=new Date(b.expiry); if(!m.soonest||d<m.soonest)m.soonest=d;}});
  return Object.entries(map).map(([id,m])=>({id:parseInt(id,10),name:m.name,unit:m.unit,onhand:m.onhand,threshold:m.threshold,soonest:m.soonest?fmtDate(m.soonest):''}));
}
function belowThreshold(rows){return rows.filter(r=>r.onhand<(r.threshold||10));}
function nearExpiry(db,days=30){const out=[]; const now=today(); db.batches.forEach(b=>{if(b.qty>0&&b.expiry){const d=new Date(b.expiry); const diff=Math.ceil((d-now)/86400000); if(diff>=0&&diff<=days){const med=db.meds.find(m=>m.id===b.medId); out.push({name:med?med.name:'?',lot:b.lot||'',exp:fmtDate(d),qty:b.qty,days:diff});}}}); return out;}
function monthlyUsage(db,y,m){const s=new Date(y,m-1,1),e=new Date(y,m,1);const agg={}; db.tx.forEach(t=>{const ts=new Date(t.ts); if(t.type==='USE'&&ts>=s&&ts<e){const med=db.meds.find(x=>x.id===t.medId); const k=med?med.name:'?'; agg[k]=(agg[k]||0)+(-t.qty);}}); return Object.entries(agg).map(([name,used])=>({name,used})).sort((a,b)=>b.used-a.used);}
function monthlyReceive(db,y,m){const s=new Date(y,m-1,1),e=new Date(y,m,1);const agg={}; db.tx.forEach(t=>{const ts=new Date(t.ts); if(t.type==='RECEIVE'&&ts>=s&&ts<e){const med=db.meds.find(x=>x.id===t.medId); const k=med?med.name:'?'; agg[k]=(agg[k]||0)+(t.qty);}}); return Object.entries(agg).map(([name,recv])=>({name,recv}));}
function useStock(db,medId,qty,note){qty=Math.max(1,parseInt(qty,10)||0);const rows=db.batches.filter(b=>b.medId===medId&&b.qty>0).sort((a,b)=>{const ae=a.expiry?new Date(a.expiry).getTime():Infinity;const be=b.expiry?new Date(b.expiry).getTime():Infinity;return ae===be?(new Date(a.rcvAt)-new Date(b.rcvAt)):ae-be;});let remain=qty;for(const b of rows){if(remain<=0)break;const take=Math.min(b.qty,remain);b.qty-=take;remain-=take;} if(remain>0)return [false,'ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.']; db.tx.push({type:'USE',medId,qty:-qty,note:note||'',ts:new Date().toISOString()}); return [true,'ok'];}
function drawBar(c,data){const ctx=c.getContext('2d'),W=c.width=c.clientWidth,H=c.height=280;ctx.clearRect(0,0,W,H);const pad=40,max=Math.max(1,...data.map(d=>d.value));ctx.strokeStyle='#334155';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,10);ctx.lineTo(pad,H-pad);ctx.lineTo(W-10,H-pad);ctx.stroke();const n=data.length,bw=Math.max(20,(W-pad-20)/Math.max(1,n)-8);data.forEach((d,i)=>{const x=pad+10+i*(bw+8);const h=(H-pad-20)*(d.value/max);ctx.fillStyle='#22c55e';ctx.fillRect(x,H-pad-h,bw,h);ctx.fillStyle='#cbd5e1';ctx.font='12px system-ui';ctx.save();ctx.translate(x+bw/2,H-pad+12);ctx.rotate(-Math.PI/6);ctx.textAlign='left';ctx.fillText(d.label,0,0);ctx.restore();ctx.fillText(String(d.value),x,H-pad-h-6);});}
function drawLine(c,labels,A,B){const ctx=c.getContext('2d'),W=c.width=c.clientWidth,H=c.height=280;ctx.clearRect(0,0,W,H);const pad=40,max=Math.max(1,...A,...B);ctx.strokeStyle='#334155';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,10);ctx.lineTo(pad,H-pad);ctx.lineTo(W-10,H-pad);ctx.stroke();const n=labels.length,step=(W-pad-20)/Math.max(1,n-1);function plot(S,col){ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();S.forEach((v,i)=>{const x=pad+i*step;const y=H-pad-(H-pad-20)*(v/Math.max(1,max));if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();} plot(A,'#22c55e'); plot(B,'#60a5fa'); ctx.fillStyle='#cbd5e1';ctx.font='12px system-ui';labels.forEach((lb,i)=>{const x=pad+i*step;ctx.fillText(lb,x-14,H-pad+14);});}
const tabs=document.querySelectorAll('#tabs button'); const sections={dash:'tab-dash',inout:'tab-inout',batches:'tab-batches',reports:'tab-reports',settings:'tab-settings'};
tabs.forEach(btn=>btn.addEventListener('click',()=>{tabs.forEach(b=>b.classList.remove('active'));btn.classList.add('active');Object.values(sections).forEach(id=>document.getElementById(id).style.display='none');document.getElementById(sections[btn.dataset.tab]).style.display='block';render();}));
document.getElementById('asof').textContent=new Date().toLocaleString();
function render(){const db=load(); const opts=db.meds.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); ['rcvMed','useMed','delMed'].forEach(id=>document.getElementById(id).innerHTML='<option value="">ì„ íƒ</option>'+opts);
  const oh=onhand(db).sort((a,b)=>a.name.localeCompare(b.name,'ko')); const tbody=document.querySelector('#tblOnhand tbody'); tbody.innerHTML=''; oh.forEach(r=>{const status=r.onhand<r.threshold?`<span class="pill danger">ì¶”ê°€ êµ¬ë§¤ ìš”ë§</span>`:''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td>${r.unit||''}</td><td>${r.onhand}</td><td>${r.threshold}</td><td>${r.soonest||''}</td><td>${status}</td>`; tbody.appendChild(tr);});
  const div=document.getElementById('alerts'); div.innerHTML=''; const low=oh.filter(x=>x.onhand<(x.threshold||10)); if(low.length===0) div.innerHTML+=`<div class="pill" style="background:#072916;color:#86efac;border-color:#14532d">ì•ˆì „ìˆ˜ì¤€ ì´ìƒ</div>`; else{const list=low.map(x=>`${x.name} (${x.onhand}/${x.threshold})`).join(', '); div.innerHTML+=`<div class="pill danger">10ê°œ ë¯¸ë§Œ: ${list}</div>`;}
  const ne=nearExpiry(db,30); if(ne.length>0){div.innerHTML+=`<div class="mt8 pill warn">ìœ í†µê¸°í•œ 30ì¼ ì´ë‚´: ${ne.map(x=>`${x.name}[${x.lot}] ${x.days}ì¼`).join(', ')}</div>`;}
  const tb=document.querySelector('#tblBatches tbody'); tb.innerHTML=''; db.batches.sort((a,b)=>{const ma=db.meds.find(x=>x.id===a.medId)?.name||'';const mb=db.meds.find(x=>x.id===b.medId)?.name||''; return ma.localeCompare(mb,'ko')||(a.expiry||'').localeCompare(b.expiry||'');}).forEach(b=>{const m=db.meds.find(x=>x.id===b.medId); const tr=document.createElement('tr'); tr.innerHTML=`<td>${m?m.name:'?'}</td><td>${b.lot||''}</td><td>${fmtDate(b.expiry)}</td><td>${b.qty}</td><td>${new Date(b.rcvAt).toLocaleDateString()}</td>`; tb.appendChild(tr);});
  const monthInp=document.getElementById('repMonth'); if(!monthInp.value){const d=new Date(); monthInp.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
  const [y,m]=monthInp.value.split('-').map(Number); const use=monthlyUsage(db,y,m).slice(0,10); const bar=document.getElementById('barTop'); drawBar(bar,use.map(x=>({label:x.name,value:x.used})));
  const n=Math.min(24,Math.max(3,parseInt(document.getElementById('repN').value||'12',10))); const labels=[],seriesUse=[],seriesRecv=[]; const now=new Date(); now.setDate(1);
  for(let i=n-1;i>=0;i--){const d=new Date(now); d.setMonth(d.getMonth()-i); const yy=d.getFullYear(),mm=d.getMonth()+1; labels.push(String(mm).padStart(2,'0')); const u=monthlyUsage(db,yy,mm).reduce((a,b)=>a+b.used,0); const r=monthlyReceive(db,yy,mm).reduce((a,b)=>a+b.recv,0); seriesUse.push(u); seriesRecv.push(r);}
  const ln=document.getElementById('lineTrend'); drawLine(ln,labels,seriesUse,seriesRecv);
}
render();
document.getElementById('btnAddMed').onclick=()=>{const db=load(); const name=document.getElementById('medName').value.trim(); if(!name){alert('ì˜ì•½í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return;} if(db.meds.some(m=>m.name===name)){alert('ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.'); return;} const unit=document.getElementById('medUnit').value.trim(); const th=parseInt(document.getElementById('medThreshold').value||'10',10); const id=(db.meds.reduce((mx,m)=>Math.max(mx,m.id),0)||0)+1; db.meds.push({id,name,unit,threshold:Math.max(1,th)}); save(db); document.getElementById('medName').value=''; render(); alert('ë“±ë¡ ì™„ë£Œ');};
document.getElementById('btnReceive').onclick=()=>{const db=load(); const medId=parseInt(document.getElementById('rcvMed').value||'0',10); if(!medId){alert('ì˜ì•½í’ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return;} const lot=document.getElementById('rcvLot').value.trim(); const exp=parseDateInput(document.getElementById('rcvExp').value); const qty=parseInt(document.getElementById('rcvQty').value||'0',10); const note=document.getElementById('rcvNote').value.trim(); if(!qty||qty<=0){alert('ì…ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.'); return;} db.batches.push({id:crypto.randomUUID(),medId,lot,expiry:exp?fmtDate(exp):null,qty,rcvAt:new Date().toISOString()}); db.tx.push({type:'RECEIVE',medId,qty,note,ts:new Date().toISOString()}); save(db); render(); alert('ì…ê³  ë°˜ì˜ ì™„ë£Œ');};
document.getElementById('btnUse').onclick=()=>{const db=load(); const medId=parseInt(document.getElementById('useMed').value||'0',10); const qty=parseInt(document.getElementById('useQty').value||'0',10); const note=document.getElementById('useNote').value.trim(); if(!medId){alert('ì˜ì•½í’ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return;} if(!qty||qty<=0){alert('ì‚¬ìš© ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.'); return;} const [ok,msg]=useStock(db,medId,qty,note); if(!ok){alert(msg); return;} save(db); render(); alert('ì‚¬ìš©(ì¶œê³ ) ë°˜ì˜ ì™„ë£Œ');};
document.getElementById('btnDelete').onclick=()=>{const db=load(); const medId=parseInt(document.getElementById('delMed').value||'0',10); if(!medId){alert('ì˜ì•½í’ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return;} if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return; db.meds=db.meds.filter(m=>m.id!==medId); db.batches=db.batches.filter(b=>b.medId!==medId); db.tx=db.tx.filter(t=>t.medId!==medId); save(db); render(); alert('ì‚­ì œ ì™„ë£Œ');};
document.getElementById('btnExport').onclick=()=>{const blob=new Blob([localStorage.getItem(KEY)||'{}'],{type:'application/json;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='med_inventory_backup.json'; a.click(); URL.revokeObjectURL(a.href);};
document.getElementById('btnImport').onclick=()=>{const file=document.getElementById('impFile').files[0]; if(!file){alert('ê°€ì ¸ì˜¬ JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return;} const fr=new FileReader(); fr.onload=()=>{try{const obj=JSON.parse(fr.result); if(!obj.meds||!obj.batches||!obj.tx) throw new Error('í˜•ì‹ ì˜¤ë¥˜'); save(obj); render(); alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');}catch(e){alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+e.message);}}; fr.readAsText(file,'utf-8');};
document.getElementById('repMonth').addEventListener('change',render);
document.getElementById('repN').addEventListener('change',render);
</script>
</body>
</html>
